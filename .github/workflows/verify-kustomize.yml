name: Verify Manifest Builds

on:
  push:
    branches:
      - 'main'
  pull_request:
    paths:
      - '.github/**'
      - 'config/**'
      - 'charts/**'
      - 'Makefile'

jobs:
  verify-builds:
    name: Verify kustomize and Helm builds
    runs-on: ubuntu-latest
    steps:
      - name: Clone the code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install kustomize
        run: make kustomize

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Verify Helm charts
        run: |
          EXIT_CODE=0
          echo "Verifying Helm charts..."
          echo ""

          for chart_dir in charts/*/; do
            if [ -f "${chart_dir}Chart.yaml" ]; then
              chart_name=$(basename "$chart_dir")
              echo "Linting chart: $chart_name"
              if helm lint "$chart_dir" > /dev/null 2>&1; then
                echo "✓ $chart_name passes lint"
              else
                echo "✗ $chart_name failed lint"
                helm lint "$chart_dir"
                EXIT_CODE=1
              fi

              echo "Building chart: $chart_name"
              if helm template test "$chart_dir" > /dev/null 2>&1; then
                echo "✓ $chart_name renders successfully"
              else
                echo "✗ $chart_name failed to render"
                helm template test "$chart_dir"
                EXIT_CODE=1
              fi
              echo ""
            fi
          done

          if [ $EXIT_CODE -ne 0 ]; then
            echo "Error: One or more Helm charts failed validation."
            exit 1
          fi

          echo "All Helm charts validated successfully!"
          echo ""

      - name: Verify config/base builds
        run: |
          echo "Building config/base..."
          bin/kustomize build config/base > /dev/null
          echo "✓ config/base builds successfully"
          echo ""

      - name: Verify kustomize overlays build
        run: |
          EXIT_CODE=0
          echo "Verifying kustomize overlays..."
          echo ""

          for overlay in config/overlays/*/; do
            overlay_name=$(basename "$overlay")
            echo "Building overlay: $overlay_name"
            if bin/kustomize build "$overlay" > /dev/null 2>&1; then
              echo "✓ $overlay_name builds successfully"
            else
              echo "✗ $overlay_name failed to build"
              bin/kustomize build "$overlay"
              EXIT_CODE=1
            fi
          done

          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "Error: One or more kustomize overlays failed to build."
            echo "Please fix the kustomization.yaml files and try again."
            exit 1
          fi

          echo ""
          echo "All kustomize overlays build successfully!"
          echo ""

      - name: Display summary
        if: success()
        run: |
          echo "==================================="
          echo "Build Verification Summary"
          echo "==================================="
          echo ""
          echo "Helm Charts:"
          for chart_dir in charts/*/; do
            if [ -f "${chart_dir}Chart.yaml" ]; then
              chart_name=$(basename "$chart_dir")
              version=$(grep '^version:' "${chart_dir}Chart.yaml" | awk '{print $2}')
              echo "  ✓ $chart_name (v$version)"
            fi
          done
          echo ""
          echo "Kustomize Overlays:"
          for overlay in config/overlays/*/; do
            overlay_name=$(basename "$overlay")
            echo "  ✓ $overlay_name"
          done
          echo ""
          echo "All manifests validated successfully!"
